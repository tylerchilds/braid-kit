<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Script Type</title>
    <link href="/cutestrap.css" rel="stylesheet">
  </head>
  <body>
    <fastmail-wizard></fastmail-wizard>
    <script src="../package.2015.js"></script>
    <script>
const $ = module('fastmail-wizard')

const modes = {
	welcome: 'welcome',
	username: 'username',
	apikey: 'apikey',
	ready: 'ready',
	misconfigured: 'misconfigured',
}

const actions = {
	goto: 'goto',
	authenticate: 'authenticate',
	next: 'next',
	back: 'back'
}

const emptyLauncher = {
	mode: 'welcome',
	nextMode: null,
	backMode: null,
	companionActive: true,
}

function launcherById(id) {
	return $.learn()[id] || emptyLauncher
}

const paginationActions = [actions.back, actions.next]

$.when('click', '[data-action]', action)
$.when('click', '[data-goto]', goTo)

const actionHandlers = {
	[modes.welcome]: (id) => [
		`
			<button data-id="${id}" data-goto="username">
				Start
			</button>
		`
	],
	[modes.username]: (id) => [
		`
			<button data-id="${id}" data-goto="apikey">
        Continue
			</button>
		`,
		`
			<button data-id="${id}" data-action="back">
				Go Back
			</button>
		`
	],
	[modes.apikey]: (id) => [
		`
      <button data-id="${id}" data-action="${actions.authenticate}">
        Continue
			</button>
		`,
		`
			<button data-id="${id}" data-action="back">
				Go Back
			</button>
		`
  ],
	[modes.ready]: (id) => [
		`
			<a href="/tray/index.html" class="button" data-id="${id}">
				Launch
			</button>
		`,
  ],
	[modes.misconfigured]: (id) => [
		`
      <button data-id="${id}" data-action="${actions.authenticate}">
				Try Again
			</button>
		`,
	],
	'default': (id) => [
		`
			<button data-id="${id}" data-goto="welcome">
				Restart
			</button>
		`
	]
}

function actionItems(id, mode) {
	const buttons = (actionHandlers[mode] || actionHandlers['default'])(id).join('')
	return `
		<actions>
			${buttons}
		</actions>	
	`
}

$.draw(target => {
	const { id } = target

	const launcher = launcherById(id)

	const renderers = {
		[modes.welcome]: () => `
				<div class="card">
					<h2>Welcome to JMAP OS</h2>
					<p>Connect to a JMAP provider</p>
					${actionItems(id, modes.welcome)}
				</div>
			`,
		[modes.username]: () => `
      <div class="card">
        <h2>What's your username</h2>
        <p>I am email@tychi.me, who are you?</p>
        <field-text label="Username" key="ls/fastmail/username"></field-text>
        ${actionItems(id, modes.username)}
      </div>
    `,
		[modes.apikey]: () => `
      <div class="card">
        <h2>Access Configuration</h2>
        <p>An API Key is used to securely access your account without leaking your password.</p>
        <field-text label="API Key" key="ls/fastmail/apikey"></field-text>
        <p>
          <small>Fastmail API Keys information <a href="https://www.fastmail.help/hc/en-us/articles/5254602856719-API-tokens">can be found here</a>.</small>
        </p>
        ${actionItems(id, modes.apikey)}
      </div>
    `,
    [modes.ready]: () => `
      <div class="card">
        <h2>You're Connected</h2>
        <p>Access to your friends and google is here.</p>
        ${actionItems(id, modes.ready)}
      </div>
    `,
		[modes.misconfigured]: () => `
      <div class="card">
        <h2>Whoops</h2>
        <p>Something went super wrong so, yeah, maybe tweak these.</p>
        <field-text label="Username" key="ls/fastmail/username"></field-text>
        <field-text label="API Key" key="ls/fastmail/apikey"></field-text>
        ${actionItems(id, modes.misconfigured)}
      </div>
    `,
		'default': () => `
      <div class="card">
        <h2>Error...</h2>
        ${actionItems(id)}
      </div>
    `
	}

	const { mode, nextMode, companionActive } = launcher
	const view = (renderers[mode] || renderers['default'])()
	const fadeOut = nextMode && mode !== nextMode

	const companionClass = companionActive ? `mode-${mode} active` : `mode-${mode}`

	target.innerHTML = `
		<button aria-label="Companion" class="switcher" data-id="${id}"></button>
		<companion class="${companionClass}">
			<transition class="${fadeOut ? 'out' : ''}" data-id="${id}">
				${view}
			</transition>
		</companion>
		`
})

$.when('click', 'button.switcher', switcher)

function switcher({target}) {
	const { id } = target.dataset
	const { companionActive } = launcherById(id)
	$.teach({ companionActive: !companionActive }, merge(id))
}

function transition({target}) {
	const { id } = target.dataset
	const { mode, nextMode, backMode } = launcherById(id)

  console.log(backMode)

	const currentMode = nextMode ? nextMode : mode
	const previousMode = mode !== backMode ? backMode : mode
	$.teach({ mode: currentMode, backMode: previousMode }, merge(id))
	target.scrollTop = '0'
	document.activeElement.blur()
}

$.when('animationend', 'transition', transition)

$.flair(`
		& {
			background: white;
			display: block;
			position: absolute;
			overflow: hidden;
			height: 100%;
			width: 100%;
			inset: 0;
		}

		& .switcher {
      border-radius: 0 0 0 100%;
			display: block;
			position: fixed;
			height: 72px;
			padding: 0;
			margin: 0;
			background: orange;
			right: 0;
			z-index: 10;
			border: 0;
			top: 0;
			width: 72px;
		}

		& actions {
      display: block;
			border: 1px solid orange;
			border-radius: 2px;
		}

		& companion {
			position: fixed;
      inset: 0;
			min-height: 1rem;
      max-width: 320px;
			z-index: 5;
			transition: opacity 100ms ease-in-out;
      opacity: 0;
			border-bottom: 1px solid orange;
      margin: auto;
		}

		& companion.active {
      opacity: 1;
		}

		& companion:not(.active) button {
			animation: &-fade-out ease-in-out 0ms;
			display: none;
		}

		& companion button {
			animation: &-fade-in ease-in-out 1000ms;
			background: white;
			color: blue;
			text-decoration: underline;
			border: none;
			border-bottom: 1px solid cyan;
			width: 100%;
			padding: .5rem;
			text-align: left;
		}

		& companion button:last-child {
			border-bottom: none;	
		}

		& button {
			display: block;
			margin: 0;
		}

		& transition {
			animation: &-fade-in ease-in-out 250ms;
			display: grid;
			height: 100%;
			place-items: center;
			width: 100%;
		}

		& transition.out {
			animation: &-fade-out ease-in-out 100ms;
		}

		& .icons {
			display: grid;
			height: 100%;
			gap: 1rem;
			grid-template-columns: repeat(auto-fill, 4rem);
			grid-template-rows: repeat(auto-fill, 4rem);
			padding: 1rem;
			width: 100%;
		}

		& .icons button {
			margin: 0;
		}

		& .card {
      overflow: auto;
			padding: 1rem;
		}

		@keyframes &-fade-in {
			0% {
				opacity: 0;
			}
			100% {
				opacity: 1;
			}
		}

		@keyframes &-fade-out {
			0% {
				opacity: 1;
			}
			100% {
				opacity: 0;
			}
		}

		@keyframes &-zoom-in {
			0% {
				transform: scale(.9);
			}
			100% {
				transform: scale(1);
			}
		}

		@keyframes &-zoom-out {
			0% {
				transform: scale(1);
			}
			100% {
				transform: scale(.9);
			}
		}
	`)
/* controller-like logic */
const welcomePath = [
	modes.welcome,
	modes.planting,
	modes.jamming,
]

function goTo({ target }) {
	const mode = target.dataset.goto
	return messageStateMachine(target, { action: actions.goto, mode })
}

function action({ target }) {
	const { action } = target.dataset
	return messageStateMachine(target, { action })
}

function dispatch(target, type, mode) {
	const states = {
		'welcome': {
      'leaving': () => `bye felicia`,
      'entering': () => `hello clarice`,
		}
	}

	if(states[mode]) {
		const change = states[mode][type] || (() => null)
		change(target)
	}
}

async function messageStateMachine(target, message) {
	const { id } = target.dataset
	const { mode, backMode } = launcherById(id)
	const { action } = message

	function setMode(nextMode) {
		dispatch(target, 'leaving', mode)
		$.teach({ nextMode }, merge(id))
		dispatch(target, 'entering', nextMode)
	}

	if(action === actions.goto) {
		setMode(message.mode)
		return
	}

  if(action === actions.authenticate) {
    try {
      const authenticated = (await fetch('/api/fastmail/fetchTen', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: state['ls/fastmail/username'],
          apikey: state['ls/fastmail/apikey'],
        })
      }).then(res => res.status)) === 200
      setMode(authenticated ? modes.ready : modes.misconfigured)
      return
    } catch(e) {
      console.log(e)
      setMode(modes.misconfigured)
    }
	}

	if(action === actions.back && backMode) {
		setMode(backMode)
		return
	}

	const onTheWelcomePath = welcomePath.includes(mode) && paginationActions.includes(action)

	if(onTheWelcomePath) {
		const order = action === actions.next
			? welcomePath
			: [...welcomePath].reverse()

		const nextIndex = order.indexOf(mode) + 1
		setMode(order[nextIndex])
		return
	}
}

function merge(id) {
	return function middleware(state, payload) {
		return {
			...state,
			[id]: {
				...emptyLauncher,
				...state[id],
				...payload
			}
		}
	}
}
    </script>
  </body>
</html>
